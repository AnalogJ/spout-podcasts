build:
    box: publysher/hugo
    steps:

    # ensure that git is installed
    - script:
        name: install git
        code: |
            apt-get update && sudo apt-get -y install git
            git version
    # move the current tomecast-podcasts files to a subfolder
    - script:
        name: move to tomecast-podcasts subfolder
        code: mkdir tomecast-podcasts && mv `ls -A | grep -v tomecast-podcasts` ./tomecast-podcasts

    # checkout the tomecast-web repo
    - script:
        name: checkout the tomecast-web repo
        code: git clone https://github.com/tomecast/tomecast-web.git

    # todo: move the tomecast-podcast content into the correct structure
    - script:
        name: populate structure
        code: |
            rsync -r --exclude=.gitignore --exclude=README.md --exclude=wercker.yml tomecast-podcasts/* tomecast-web/content
            cd tomecast-web/content

            # copy the metadata files into the data folder.
            find -type d -exec mv -n -- {}/metadata.json ../data/{}.json \;

            # copy the cover art to the static/img/covers folder
            find -type d -exec mv -n -- {}/cover.jpg ../static/img/covers/{}.jpg \;

            #for the content files, make sure that we rename the extension to md, instead of json so that hugo will process them.
            cd ../ && find ./content -type f -name "*.json" -print0 | xargs -0 rename 's/.json$/.md/'


    # todo: generate the static site using hugo
    - script:
        name: hugo process site
        code: |
            hugo version
            cd tomecast-web && hugo -v

    # todo: deploy to github pages or aws s3.

    # example from:  http://devcenter.wercker.com/docs/containers/minimal-containers.html
deploy :
    steps :
    - script:
        name: Configure git
        code: |-
            git config --global user.email "pleasemailus@wercker.com"
            git config --global user.name "wercker"

            # remove current .git folder
            rm -rf .git
            rm -rf tomecast-web/.git
    - script:
        name: Deploy to github pages
        code: |-
            cd tomecast-web/public
            git init
            git add .
            git commit -m "deploy commit from $WERCKER_STARTED_BY"
            git push -f $GIT_REMOTE master:gh-pages